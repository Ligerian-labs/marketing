---
export const prerender = false;
import Base from "../../layouts/Base.astro";
import { getAuthenticatedUser } from "../../lib/auth";
import { getUserSubscriptions } from "../../lib/subscriptions";
import { PACKS } from "../../lib/stripe";

const user = getAuthenticatedUser(Astro.cookies);
if (!user) return Astro.redirect("/auth/login");

const subscriptions = getUserSubscriptions(user.id);

const packLabels: Record<string, string> = {
  "agent-starter": "ğŸš€ Agent Starter",
  "openclaw-setup": "ğŸ§  Agent sur mesure",
  "moderation-support": "ğŸ›¡ï¸ ModÃ©ration IA",
};

const statusLabels: Record<string, { text: string; class: string }> = {
  active: { text: "Actif", class: "bg-green-900/30 text-green-400 border-green-500/30" },
  pending: { text: "En attente", class: "bg-yellow-900/30 text-yellow-400 border-yellow-500/30" },
  deploying: { text: "DÃ©ploiement", class: "bg-blue-900/30 text-blue-400 border-blue-500/30" },
  cancelled: { text: "AnnulÃ©", class: "bg-red-900/30 text-red-400 border-red-500/30" },
};
---

<Base title="Tableau de bord â€” Ligerian Labs">
  <section class="max-w-6xl mx-auto px-6 py-12">
    <!-- Header -->
    <div class="flex justify-between items-center mb-12">
      <div>
        <h1 class="text-3xl font-bold">Bonjour, {user.name} ğŸ‘‹</h1>
        <p class="text-gray-400 mt-1">{user.email}{user.company ? ` Â· ${user.company}` : ""}</p>
      </div>
      <form method="POST" action="/api/auth/logout">
        <button type="submit" class="text-sm text-muted hover:text-white transition">
          DÃ©connexion
        </button>
      </form>
    </div>

    <!-- Subscriptions -->
    <h2 class="text-xl font-semibold mb-6">Vos services</h2>

    {subscriptions.length === 0 ? (
      <div class="bg-surface border border-white/5 rounded-xl p-12 text-center">
        <p class="text-gray-400 mb-6">Vous n'avez pas encore de service actif.</p>
        <a href="/services" class="bg-accent hover:bg-accent-light text-white px-6 py-3 rounded-lg font-medium transition inline-block">
          DÃ©couvrir nos offres â†’
        </a>
      </div>
    ) : (
      <div class="grid md:grid-cols-2 gap-6 mb-12">
        {subscriptions.map((sub) => {
          const status = statusLabels[sub.status] || statusLabels.pending;
          return (
            <a href={`/dashboard/${sub.id}`} class="bg-surface border border-white/5 rounded-xl p-6 hover:border-accent/30 transition group block">
              <div class="flex justify-between items-start mb-4">
                <h3 class="text-lg font-semibold group-hover:text-accent transition">
                  {packLabels[sub.pack] || sub.pack}
                </h3>
                <span class={`text-xs px-2 py-1 rounded-full border ${status.class}`}>
                  {status.text}
                </span>
              </div>

              <div class="space-y-2 text-sm text-gray-400">
                {sub.server_ip && (
                  <p>ğŸ–¥ï¸ Serveur: <span class="text-white font-mono">{sub.server_ip}</span> ({sub.server_provider})</p>
                )}
                {sub.tailscale_hostname && (
                  <p>ğŸ”— Tailscale: <span class="text-white font-mono">{sub.tailscale_hostname}</span></p>
                )}
                {sub.channel_type && (
                  <p>{sub.channel_connected ? "âœ…" : "â³"} Canal: {sub.channel_type}</p>
                )}
              </div>

              <p class="text-xs text-muted mt-4">
                CrÃ©Ã© le {new Date(sub.created_at).toLocaleDateString("fr-FR")}
              </p>
            </a>
          );
        })}
      </div>
    )}

    <!-- Quick Actions -->
    <h2 class="text-xl font-semibold mb-6">Actions rapides</h2>
    <div class="grid md:grid-cols-3 gap-6">
      <a href="/services" class="bg-surface border border-white/5 rounded-xl p-6 hover:border-accent/30 transition text-center">
        <div class="text-2xl mb-2">â•</div>
        <p class="font-medium">Ajouter un service</p>
      </a>
      <a href="/contact" class="bg-surface border border-white/5 rounded-xl p-6 hover:border-accent/30 transition text-center">
        <div class="text-2xl mb-2">ğŸ’¬</div>
        <p class="font-medium">Nous contacter</p>
      </a>
      <a href="/blog" class="bg-surface border border-white/5 rounded-xl p-6 hover:border-accent/30 transition text-center">
        <div class="text-2xl mb-2">ğŸ“š</div>
        <p class="font-medium">Lire le blog</p>
      </a>
    </div>
  </section>
</Base>
