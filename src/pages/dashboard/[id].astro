---
export const prerender = false;
import Base from "../../layouts/Base.astro";
import { getAuthenticatedUser } from "../../lib/auth";
import db from "../../lib/db";

const user = getAuthenticatedUser(Astro.cookies);
if (!user) {
  return Astro.redirect("/auth/connexion");
}

const { id } = Astro.params;
const subscription = db.prepare(
  "SELECT * FROM subscriptions WHERE id = ? AND user_id = ?"
).get(id, user.id) as any;

if (!subscription) {
  return Astro.redirect("/dashboard");
}

const resources = db.prepare(
  "SELECT * FROM resources WHERE subscription_id = ? ORDER BY created_at DESC"
).all(subscription.id) as any[];

const statusSteps = [
  { key: "pending", label: "Commande re√ßue" },
  { key: "provisioning", label: "Provisionnement" },
  { key: "configuring", label: "Configuration" },
  { key: "testing", label: "Tests" },
  { key: "active", label: "En production" },
];

const currentStepIndex = statusSteps.findIndex((s) => s.key === subscription.status);
---

<Base title={`${subscription.pack} ‚Äî Espace client`}>
  <section class="max-w-4xl mx-auto px-6 py-20">
    <a href="/dashboard" class="text-sm text-muted hover:text-white transition">‚Üê Retour au dashboard</a>

    <div class="mt-6 mb-10">
      <h1 class="text-3xl font-bold">{subscription.pack}</h1>
      <p class="text-muted mt-1">Souscrit le {new Date(subscription.created_at).toLocaleDateString('fr-FR')}</p>
    </div>

    <!-- Progress Steps -->
    <div class="bg-surface border border-white/5 rounded-xl p-6 mb-8">
      <h2 class="font-semibold mb-4">Statut du d√©ploiement</h2>
      <div class="flex gap-4">
        {statusSteps.map((step, i) => {
          const done = currentStepIndex >= i;
          const active = currentStepIndex === i;
          const barClass = done ? "bg-accent" : "bg-white/10";
          const textClass = active ? "text-accent font-medium" : done ? "text-white" : "text-muted";
          return (
            <div class="flex-1">
              <div class={`h-2 rounded-full mb-2 ${barClass}`} />
              <p class={`text-sm ${textClass}`}>{step.label}</p>
            </div>
          );
        })}
      </div>
    </div>

    <!-- Infrastructure Details -->
    {subscription.server_ip && (
      <div class="bg-surface border border-white/5 rounded-xl p-6 mb-8">
        <h2 class="font-semibold mb-4">Infrastructure</h2>
        <div class="grid md:grid-cols-2 gap-6">
          {subscription.server_ip && (
            <div>
              <span class="text-muted text-sm">Adresse serveur</span>
              <p class="text-white font-mono mt-1">{subscription.server_ip}</p>
            </div>
          )}
          {subscription.server_provider && (
            <div>
              <span class="text-muted text-sm">Fournisseur</span>
              <p class="text-white mt-1">{subscription.server_provider}</p>
            </div>
          )}
          {subscription.tailscale_hostname && (
            <div>
              <span class="text-muted text-sm">R√©seau Tailscale</span>
              <p class="text-white font-mono mt-1">{subscription.tailscale_hostname}</p>
            </div>
          )}
          {subscription.openclaw_version && (
            <div>
              <span class="text-muted text-sm">Version OpenClaw</span>
              <p class="text-white mt-1">v{subscription.openclaw_version}</p>
            </div>
          )}
          {subscription.channel_type && (
            <div>
              <span class="text-muted text-sm">Canal</span>
              <p class="text-white mt-1">{subscription.channel_type} {subscription.channel_connected ? '‚úÖ' : '‚è≥'}</p>
            </div>
          )}
        </div>
      </div>
    )}

    <!-- Resources -->
    {resources.length > 0 && (
      <div class="bg-surface border border-white/5 rounded-xl p-6">
        <h2 class="font-semibold mb-4">Ressources</h2>
        <div class="space-y-3">
          {resources.map((r: any) => (
            <div class="flex items-center justify-between py-3 border-b border-white/5 last:border-0">
              <div>
                <p class="font-medium">{r.title}</p>
                <p class="text-muted text-sm">{r.type}</p>
              </div>
              {r.file_path && (
                <span class="text-accent text-sm">üìÑ T√©l√©charger</span>
              )}
            </div>
          ))}
        </div>
      </div>
    )}

    {resources.length === 0 && !subscription.server_ip && (
      <div class="bg-surface border border-white/5 rounded-xl p-8 text-center">
        <p class="text-muted">Votre d√©ploiement est en cours de pr√©paration. Vous recevrez un email d√®s que tout sera pr√™t.</p>
      </div>
    )}
  </section>
</Base>
