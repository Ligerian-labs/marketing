---
export const prerender = false;
import Base from "../../layouts/Base.astro";
import { getUserByEmail, createPasswordToken } from "../../lib/auth";
import { sendPasswordResetEmail } from "../../lib/email";

let sent = false;
let error = "";

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const email = formData.get("email")?.toString()?.trim();

  if (!email) {
    error = "Veuillez entrer votre adresse email.";
  } else {
    // Always show success to prevent email enumeration
    sent = true;

    const user = getUserByEmail(email);
    if (user) {
      try {
        const token = createPasswordToken(user.id);
        await sendPasswordResetEmail(email, user.name, token);
        console.log(`[AUTH] Password reset email sent to ${email}`);
      } catch (err) {
        console.error(`[AUTH] Failed to send reset email to ${email}:`, err);
      }
    }
  }
}
---

<Base title="Mot de passe oublié — Ligerian Labs">
  <section class="max-w-md mx-auto px-6 py-20">
    <h1 class="text-3xl font-bold mb-2 text-center">Mot de passe oublié</h1>
    <p class="text-gray-400 text-center mb-8">Recevez un lien pour réinitialiser votre mot de passe</p>

    {error && (
      <div class="bg-red-900/30 border border-red-500/30 rounded-lg p-4 mb-6 text-red-400 text-sm text-center">
        {error}
      </div>
    )}

    {sent ? (
      <div class="bg-green-900/30 border border-green-500/30 rounded-lg p-6 text-center">
        <p class="text-green-400 font-medium mb-2">✉️ Email envoyé !</p>
        <p class="text-gray-400 text-sm">
          Si un compte existe avec cette adresse, vous recevrez un lien de réinitialisation d'ici quelques minutes.
        </p>
        <a href="/auth/connexion" class="inline-block mt-4 text-accent hover:text-accent-light text-sm">
          ← Retour à la connexion
        </a>
      </div>
    ) : (
      <>
        <form method="POST" class="space-y-5">
          <div>
            <label for="email" class="form-label">Email</label>
            <input type="email" id="email" name="email" required class="form-input" placeholder="votre@email.fr" />
          </div>
          <button type="submit" class="w-full bg-accent hover:bg-accent-light text-white px-6 py-3 rounded-lg font-medium transition">
            Envoyer le lien
          </button>
        </form>

        <p class="text-center text-sm text-muted mt-6">
          <a href="/auth/connexion" class="text-accent hover:text-accent-light">← Retour à la connexion</a>
        </p>
      </>
    )}
  </section>
</Base>
