---
export const prerender = false;
import Base from "../../../layouts/Base.astro";
import { getAuthenticatedUser } from "../../../lib/auth";
import { hasAccess, getFormationContent, FORMATION_TIERS, resolveFormationTier } from "../../../lib/formations";
import { marked } from 'marked';

const { tier, chapter } = Astro.params;
const resolvedTier = tier ? resolveFormationTier(tier) : null;

if (!resolvedTier || !chapter) {
  return Astro.redirect("/formations/", 302);
}

const formation = FORMATION_TIERS[resolvedTier];

const user = await getAuthenticatedUser(Astro);

if (!user) {
  return Astro.redirect(`/auth/connexion?redirect=/formations/${tier}/${chapter}`);
}

if (!hasAccess(user.id, formation.tier_dir)) {
  return Astro.redirect("/formations/");
}
const content = await getFormationContent(formation.tier_dir, chapter);

if (!content) {
  return Astro.redirect(`/formations/${tier}/`);
}

// Configure marked for better HTML output
marked.setOptions({
  breaks: true,
  gfm: true,
  headerIds: true,
  headerPrefix: 'heading-'
});

const htmlContent = marked(content);

// Extract title from the first heading in markdown or use filename
let title = chapter.replace(/^\d+-/, '').replace(/-/g, ' ')
  .replace(/\b\w/g, l => l.toUpperCase());

const titleMatch = content.match(/^#\s+(.+)$/m);
if (titleMatch) {
  title = titleMatch[1];
}
---

<Base title={`${title} — ${formation.name} | Ligerian Labs`} description={`Chapitre "${title}" de la formation "${formation.name}"`}>
  <div class="max-w-4xl mx-auto px-6 py-16">
    <!-- Breadcrumb -->
    <nav class="mb-8">
      <a href="/formations/" class="text-primary hover:underline">Formations</a>
      <span class="mx-2 text-text-secondary">›</span>
      <a href={`/formations/${tier}/`} class="text-primary hover:underline">{formation.name}</a>
      <span class="mx-2 text-text-secondary">›</span>
      <span class="text-text-secondary">{title}</span>
    </nav>

    <!-- Chapter Content -->
    <article class="prose prose-lg prose-gray max-w-none">
      <Fragment set:html={htmlContent} />
    </article>

    <!-- Navigation -->
    <div class="mt-16 pt-8 border-t border-white/5 flex justify-between items-center">
      <a 
        href={`/formations/${tier}/`}
        class="inline-flex items-center gap-2 text-primary hover:underline font-medium"
      >
        ← Retour au sommaire
      </a>
      
      <a 
        href="/formations/"
        class="inline-flex items-center gap-2 text-text-secondary hover:text-primary font-medium"
      >
        Toutes les formations →
      </a>
    </div>
  </div>

  <style>
    /* Custom prose styles for dark theme */
    .prose {
      color: #1f2937;
      max-width: none;
    }
    
    .prose h1, .prose h2, .prose h3, .prose h4, .prose h5, .prose h6 {
      color: #111827;
      font-weight: 700;
    }
    
    .prose h1 {
      font-size: 2.25rem;
      line-height: 1.2;
      margin-bottom: 1rem;
      margin-top: 0;
    }
    
    .prose h2 {
      font-size: 1.875rem;
      line-height: 1.3;
      margin-top: 2rem;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .prose h3 {
      font-size: 1.5rem;
      margin-top: 1.5rem;
      margin-bottom: 0.75rem;
    }
    
    .prose p {
      margin-bottom: 1.25rem;
      line-height: 1.7;
    }
    
    .prose ul, .prose ol {
      margin-bottom: 1.25rem;
      padding-left: 1.625rem;
    }
    
    .prose li {
      margin-bottom: 0.5rem;
      line-height: 1.6;
    }
    
    .prose blockquote {
      border-left: 4px solid #6366f1;
      background: #f8fafc;
      padding: 1rem 1.5rem;
      margin: 1.5rem 0;
      border-radius: 0.5rem;
      font-style: italic;
    }
    
    .prose code {
      background: #f1f5f9;
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-size: 0.875em;
      font-weight: 600;
      color: #1e293b;
    }
    
    .prose pre {
      background: #1e293b;
      color: #e2e8f0;
      padding: 1.5rem;
      border-radius: 0.5rem;
      overflow-x: auto;
      margin: 1.5rem 0;
    }
    
    .prose pre code {
      background: transparent;
      padding: 0;
      color: inherit;
      font-weight: normal;
    }
    
    .prose a {
      color: #6366f1;
      text-decoration: underline;
      text-decoration-color: transparent;
      transition: text-decoration-color 0.2s;
    }
    
    .prose a:hover {
      text-decoration-color: currentColor;
    }
    
    .prose img {
      margin: 1.5rem 0;
      border-radius: 0.5rem;
      box-shadow: 0 10px 25px -10px rgba(0, 0, 0, 0.1);
    }
    
    .prose table {
      width: 100%;
      border-collapse: collapse;
      margin: 1.5rem 0;
    }
    
    .prose th, .prose td {
      border: 1px solid #e5e7eb;
      padding: 0.75rem 1rem;
      text-align: left;
    }
    
    .prose th {
      background: #f9fafb;
      font-weight: 600;
    }
    
    .prose hr {
      border: none;
      border-top: 1px solid #e5e7eb;
      margin: 2rem 0;
    }
  </style>
</Base>