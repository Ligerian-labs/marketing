---
export const prerender = false;
import Base from "../../layouts/Base.astro";
import { getAuthenticatedUser } from "../../lib/auth";
import { getUserPurchases } from "../../lib/formations";
import type { PackId } from "../../lib/stripe";

const user = getAuthenticatedUser(Astro.cookies);
const purchases = user ? getUserPurchases(user.id) : [];

// Handle ?buy= param — redirect to register/login then checkout
const buyPack = Astro.url.searchParams.get("buy");
if (buyPack && ["formation-starter", "formation-intermediate", "formation-premium"].includes(buyPack)) {
  if (!user) {
    // Not logged in → register first, then come back to buy
    return Astro.redirect(`/auth/register?redirect=${encodeURIComponent(`/formations/?buy=${buyPack}`)}`);
  }
  // Already purchased? Go to content
  const alreadyOwned = purchases.some(p => p.pack === buyPack && p.status === "completed");
  if (alreadyOwned) {
    const tierDirs: Record<string, string> = { "formation-starter": "01-guide-pme", "formation-intermediate": "02-automatiser", "formation-premium": "03-deployer" };
    return Astro.redirect(`/formations/${tierDirs[buyPack]}/`);
  }
  // Logged in → go to Stripe checkout
  const { createCheckoutSession: checkout } = await import("../../lib/stripe");
  const checkoutUrl = await checkout(
    buyPack as any,
    user.email,
    user.id,
    `${Astro.url.origin}/formations/?payment=success`,
    `${Astro.url.origin}/formations/?payment=cancelled`
  );
  if (checkoutUrl) return Astro.redirect(checkoutUrl);
}

const formations = [
  {
    id: 'formation-starter',
    name: 'IA pour les PME',
    description: 'Guide pratique pour intégrer l\'IA dans votre PME',
    price: '49€',
    tier_dir: '01-guide-pme',
    features: [
      'Comprendre l\'IA sans jargon technique',
      'Cas d\'usage concrets pour PME',
      'Outils no-code recommandés', 
      'Votre premier projet IA',
      'Erreurs à éviter',
      'Ressources et accompagnement'
    ]
  },
  {
    id: 'formation-intermediate',
    name: 'Automatiser son Business',
    description: 'Workflows et automatisations IA pour votre entreprise',
    price: '99€',
    tier_dir: '02-automatiser',
    features: [
      'Mindset et stratégie d\'automatisation',
      'Stack IA moderne',
      'Automatiser marketing, ops et ventes',
      'Construire des workflows robustes',
      'Métriques et optimisation',
      'Plan d\'action personnalisé'
    ]
  },
  {
    id: 'formation-premium', 
    name: 'Déployer l\'IA en Entreprise',
    description: 'Stratégie et architecture IA pour grandes organisations',
    price: '149€',
    tier_dir: '03-deployer',
    features: [
      'Stratégie IA d\'entreprise',
      'Architecture technique avancée', 
      'LLM en production',
      'Data governance et sécurité',
      'Équipes et compétences',
      'Éthique et conformité',
      'Cas d\'études détaillés',
      'Feuille de route complète'
    ]
  }
];

const hasPurchased = (formationId: string) => {
  return purchases.some(p => p.pack === formationId && p.status === 'completed');
};
---

<Base title="Formations IA — Ligerian Labs" description="Formations pratiques pour maîtriser l'Intelligence Artificielle dans votre entreprise">
  {Astro.url.searchParams.get("payment") === "success" && (
    <div class="bg-green-50 border-b border-green-200 text-green-800 text-center py-3 px-6 text-sm font-medium">
      ✅ Paiement réussi ! Votre formation est maintenant accessible ci-dessous.
    </div>
  )}
  {Astro.url.searchParams.get("payment") === "cancelled" && (
    <div class="bg-yellow-50 border-b border-yellow-200 text-yellow-800 text-center py-3 px-6 text-sm font-medium">
      Paiement annulé. Vous pouvez réessayer quand vous le souhaitez.
    </div>
  )}
  <!-- Hero -->
  <section class="max-w-5xl mx-auto px-6 py-28 md:py-36 text-center">
    <p class="section-label mb-8">Formations IA pratiques</p>
    <h1 class="text-5xl md:text-7xl font-bold tracking-tight mb-6 leading-[1.1]">
      Maîtrisez l'IA<br />pour votre entreprise
    </h1>
    <p class="text-xl text-text-secondary max-w-2xl mx-auto mb-12 leading-relaxed">
      Formations pratiques et concrètes pour intégrer l'Intelligence Artificielle
      dans votre activité. Du débutant à l'expert.
    </p>
  </section>

  <!-- Formations Grid -->
  <section class="bg-surface py-24">
    <div class="max-w-6xl mx-auto px-6">
      <div class="grid md:grid-cols-3 gap-8">
        {formations.map((formation) => {
          const purchased = hasPurchased(formation.id);
          return (
            <div class="bg-white rounded-2xl p-8 border border-black/5 hover:shadow-lg transition">
              <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold">{formation.name}</h3>
                <span class="text-2xl font-bold text-accent">{formation.price}</span>
              </div>
              
              <p class="text-text-secondary mb-6 leading-relaxed">
                {formation.description}
              </p>
              
              <ul class="space-y-3 mb-8">
                {formation.features.map((feature) => (
                  <li class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                    </svg>
                    <span class="text-sm">{feature}</span>
                  </li>
                ))}
              </ul>
              
              {purchased ? (
                <a 
                  href={`/formations/${formation.tier_dir}/`}
                  class="block w-full bg-green-600 text-white text-center py-3 px-6 rounded-lg font-medium hover:bg-green-700 transition"
                >
                  Accéder au contenu →
                </a>
              ) : user ? (
                <form action="/api/stripe/checkout" method="POST" class="w-full">
                  <input type="hidden" name="pack" value={formation.id} />
                  <button 
                    type="submit"
                    class="w-full bg-accent text-white py-3 px-6 rounded-lg font-medium hover:accent-light transition"
                  >
                    Acheter maintenant
                  </button>
                </form>
              ) : (
                <a 
                  href={`/auth/register?redirect=${encodeURIComponent(`/formations/?buy=${formation.id}`)}`}
                  class="block w-full bg-accent text-white text-center py-3 px-6 rounded-lg font-medium hover:accent-light transition"
                >
                  Créer un compte et acheter
                </a>
              )}
            </div>
          )
        })}
      </div>
      
      {!user && (
        <div class="mt-12 text-center">
          <p class="text-text-secondary">
            Déjà un compte ? <a href="/auth/login?redirect=/formations/" class="text-accent font-medium hover:underline">Se connecter pour accéder à vos formations</a>
          </p>
        </div>
      )}
    </div>
  </section>
</Base>