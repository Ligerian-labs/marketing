---
export const prerender = false;
import Base from "../../layouts/Base.astro";
import { getAuthenticatedUser } from "../../lib/auth";
import { getUserPurchases } from "../../lib/formations";
import type { PackId } from "../../lib/stripe";

const user = getAuthenticatedUser(Astro.cookies);
const purchases = user ? getUserPurchases(user.id) : [];

// Handle ?buy= param ‚Äî direct to Stripe checkout (no auth required)
const buyPack = Astro.url.searchParams.get("buy");
if (buyPack && ["formation-starter", "formation-intermediate", "formation-premium"].includes(buyPack)) {
  // If logged in and already purchased, go to content
  if (user) {
    const alreadyOwned = purchases.some(p => p.pack === buyPack && p.status === "completed");
    if (alreadyOwned) {
      const tierDirs: Record<string, string> = { "formation-starter": "01-guide-pme", "formation-intermediate": "02-automatiser", "formation-premium": "03-deployer" };
      return Astro.redirect(`/formations/${tierDirs[buyPack]}/`);
    }
  }
  
  // Create Stripe checkout session (works for authenticated and non-authenticated users)
  const { createCheckoutSession: checkout } = await import("../../lib/stripe");
  const checkoutUrl = await checkout(
    buyPack as any,
    user?.email || null,  // Let Stripe collect email if not logged in
    user?.id || null,     // No user ID for post-payment flow
    `${Astro.url.origin}/formations/?payment=success`,
    `${Astro.url.origin}/formations/?payment=cancelled`
  );
  if (checkoutUrl) return Astro.redirect(checkoutUrl);
}

const formations = [
  {
    id: 'formation-starter',
    name: 'IA pour les PME',
    label: 'Starter',
    description: 'Comprendre l\'IA et lancer votre premier projet en 30 jours.',
    price: 49,
    tier_dir: '01-guide-pme',
    popular: false,
    chapters: 6,
    features: [
      'Comprendre l\'IA sans jargon',
      'Cas d\'usage concrets pour PME',
      'Outils no-code recommand√©s',
      'Premier projet IA pas √† pas',
      'Erreurs √† √©viter',
    ]
  },
  {
    id: 'formation-intermediate',
    name: 'Automatiser son Business',
    label: 'Interm√©diaire',
    description: 'Construire des workflows IA qui tournent en continu.',
    price: 99,
    tier_dir: '02-automatiser',
    popular: true,
    chapters: 8,
    features: [
      'Tout le contenu Starter inclus',
      'Stack IA moderne (LLMs, APIs, RAG)',
      'Automatiser marketing & ventes',
      'Workflows Make.com & n8n',
      'Plan d\'action 90 jours',
    ]
  },
  {
    id: 'formation-premium',
    name: 'D√©ployer l\'IA en Entreprise',
    label: 'Premium',
    description: 'Architecture, gouvernance et mise en production √† l\'√©chelle.',
    price: 149,
    tier_dir: '03-deployer',
    popular: false,
    chapters: 9,
    features: [
      'Tout le contenu pr√©c√©dent inclus',
      'Architecture technique avanc√©e',
      'LLMs en production',
      'Gouvernance, s√©curit√© & EU AI Act',
      '5 cas d\'√©tudes d√©taill√©s',
    ]
  }
];

const hasPurchased = (formationId: string) => {
  return purchases.some(p => p.pack === formationId && p.status === 'completed');
};
---

<Base title="Formations IA ‚Äî Ligerian Labs" description="Formations pratiques pour ma√Ætriser l'Intelligence Artificielle dans votre entreprise">
  {Astro.url.searchParams.get("payment") === "success" && (
    <div class="bg-green-50 border-b border-green-200 text-green-800 text-center py-3 px-6 text-sm font-medium">
      ‚úÖ Paiement r√©ussi ! Votre formation est maintenant accessible ci-dessous.
    </div>
  )}
  {Astro.url.searchParams.get("setup") === "success" && (
    <div class="bg-green-50 border-b border-green-200 text-green-800 text-center py-3 px-6 text-sm font-medium">
      üéâ Compte configur√© avec succ√®s ! Bienvenue chez Ligerian Labs. Vos formations vous attendent ci-dessous.
    </div>
  )}
  {Astro.url.searchParams.get("payment") === "cancelled" && (
    <div class="bg-yellow-50 border-b border-yellow-200 text-yellow-800 text-center py-3 px-6 text-sm font-medium">
      Paiement annul√©. Vous pouvez r√©essayer quand vous le souhaitez.
    </div>
  )}
  <!-- Hero -->
  <section class="max-w-5xl mx-auto px-6 py-28 md:py-36 text-center">
    <p class="section-label mb-8">Formations IA pratiques</p>
    <h1 class="text-5xl md:text-7xl font-bold tracking-tight mb-6 leading-[1.1]">
      Ma√Ætrisez l'IA<br />pour votre entreprise
    </h1>
    <p class="text-xl text-text-secondary max-w-2xl mx-auto mb-12 leading-relaxed">
      Formations pratiques et concr√®tes pour int√©grer l'Intelligence Artificielle
      dans votre activit√©. Du d√©butant √† l'expert.
    </p>
  </section>

  <!-- Formations Grid -->
  <section class="bg-surface py-24">
    <div class="max-w-5xl mx-auto px-6">
      <div class="grid md:grid-cols-3 gap-6 items-stretch">
        {formations.map((formation) => {
          const purchased = hasPurchased(formation.id);
          return (
            <div class={`bg-white rounded-2xl flex flex-col relative ${formation.popular ? 'ring-2 ring-black shadow-xl md:-my-4 md:py-2' : 'border border-black/8'}`}>
              {formation.popular && (
                <div class="absolute -top-3.5 left-1/2 -translate-x-1/2">
                  <span class="bg-black text-white text-xs font-semibold px-4 py-1.5 rounded-full">
                    Le plus populaire
                  </span>
                </div>
              )}

              <div class="p-8 pb-0">
                <p class="text-xs font-semibold uppercase tracking-widest text-text-secondary mb-3">{formation.label}</p>
                <h3 class="text-xl font-bold mb-2">{formation.name}</h3>
                <p class="text-text-secondary text-sm mb-6 leading-relaxed">{formation.description}</p>

                <div class="flex items-baseline gap-1 mb-8">
                  <span class="text-4xl font-bold">{formation.price}</span>
                  <span class="text-text-secondary text-lg">‚Ç¨</span>
                  <span class="text-text-secondary text-sm ml-1">¬∑ {formation.chapters} chapitres</span>
                </div>
              </div>

              <div class="px-8 flex-grow">
                <div class="border-t border-black/5 pt-6">
                  <ul class="space-y-3">
                    {formation.features.map((feature) => (
                      <li class="flex items-start gap-3">
                        <svg class="w-4 h-4 mt-0.5 text-black shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5"/>
                        </svg>
                        <span class="text-sm text-text-secondary">{feature}</span>
                      </li>
                    ))}
                  </ul>
                </div>
              </div>

              <div class="p-8 pt-8 mt-auto">
                {purchased ? (
                  <a
                    href={`/formations/${formation.tier_dir}/`}
                    class="block w-full text-center py-3 px-6 rounded-xl font-medium bg-black text-white hover:bg-black/80 transition"
                  >
                    Acc√©der au contenu ‚Üí
                  </a>
                ) : (
                  <form action="/api/stripe/checkout" method="POST" class="w-full">
                    <input type="hidden" name="pack" value={formation.id} />
                    <button
                      type="submit"
                      class={`w-full py-3 px-6 rounded-xl font-medium transition ${formation.popular ? 'bg-black text-white hover:bg-black/80' : 'bg-white text-black border-2 border-black hover:bg-black hover:text-white'}`}
                    >
                      Acheter
                    </button>
                  </form>
                )}
              </div>
            </div>
          )
        })}
      </div>

      {!user && (
        <p class="text-center text-sm text-text-secondary mt-10">
          D√©j√† un compte ?
          <a href="/auth/connexion?redirect=/formations/" class="text-black font-medium hover:underline ml-1">Se connecter</a>
        </p>
      )}
    </div>
  </section>
</Base>